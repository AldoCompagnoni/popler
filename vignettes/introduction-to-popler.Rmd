---
title: "Introduction to popler"
author: "Aldo Compagnoni"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to popler}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The popler R package is an interface that allows browsing and querying population data collected at Long Term Ecological Research (LTER) network sites located across the United States of America. A subset of the population data from the LTER network is contained in an online database called `popler`. The popler R package is an interface to this online database, allowing users to:

- explore *what* type of population data is contained in the `popler` database
- download data contained in the `popler` database


## Installation

The popler R package is currently in the development phase, and it should be downloaded directly from its [GitHub page](https://github.com/AldoCompagnoni/popler). Before doing this, make sure to install the [Devtools R package](https://cran.r-project.org/web/packages/devtools/README.html). Once devtools is installed on your machine, install and load popler:

```{r, message = FALSE, warning = FALSE}
#devtools::install_github("AldoCompagnoni/popler", build_vignettes = TRUE)
library(popler)
```

## Metadata: *what* type of data is contained in the popler database?

The LTER network provides data from thousands of research projects. The metadata of these projects allow understanding *what* population data is provided by each project. The popler R package provides three functions to explore these metadata.

### dictionary()

`dictionary()` shows:

- what are the variables contained in the metadata of each project and their meaning 
- what data these variables contain.

To see metadata variables and their meaning:  

```{r}
dictionary()
```

To show what data each variable actually contains, specify one or more variable:

```{r}
dictionary(lterid, duration_years)
```
Last, but not least, the same information provided by `dictionary` can be visualized in an html page containing hyperlinks. To open such html page, execute the `report_dictionary` function. 

```
report_dictionary()
```

### browse()

`browse()` accesses and subsets the popler metadata table directly. Calling the function returns a table that contains the metadata of all the projects in `popler`:

```{r}
browse()
```

This metadata table can be subset by specifying a logical expression. This is useful to focus on datasets of interest.

```{r}
poa_metadata   <- browse(genus == "Poa" & species == "fendleriana")
poa_metadata
```

Moreover, akin to `report_dictionary`, browse can generate a report and open it as an html page. To do so, set the `report` variable to TRUE:   

```
browse(lterid == "SEV", report = TRUE)
```

#### The keyword argument

`browse` can also single out projects based on partial matching of all of the variables that are made of strings. Specify the string you want to search using the `keyword` argument: 

```
browse(keyword == "parasite", report = TRUE)
```

## Download data

Once you identified one or more datasets of interest, download their raw data using `get_data()`. You can download data in three ways:

1. By providing `get_data` with an object created subsetting the metadata table using `browse()` 
1. By further subsetting an object created through `browse()`
1. By subsetting the popler database directly through `get_data()`

A few examples on how to the use of `get_data()` are:

```
poa_metadata <- browse(genus == "Poa" & species == "fendleriana")
poa_d        <- get_data(poa_metadata)
poa_d_09     <- get_data(poa_metadata, year > 2008)
parasite_d   <- get_data(proj_metadata_key == 25)

```

### Carefully vet the methods of downloaded data sets.

We urge the user to carefully read the documentation of each project before using it for research purposes. Data sets downloaded with `popler` share data structure, but each project has its peculiarities. To show the *metadata* of the downloaded data sets, use `report_metadata` on the data object produced by `get_data`. To read the *methods* of each project, click on  the 'metadata link' hyperlink provided in the html page.

```
report_metadata(poa_d)

```

### Data structure

All objects produced by `get_data` have the same structure. Most variable names are intuitive, but there are at least two nonintuitive variable types.

1. Variable names that match the pattern `spatial_replication_level_` refers to *nested* levels of spatial replication. For example, `spatial_replication_level_1` can represent a site, and `spatial_replication_level_2` represents a plot. In this specific case, `spatial_replication_level_1_label` will contain the string 'site', and `spatial_replication_level_2_label` will contain the string 'plot'.

1. For data sets that contain data on multiple species, data on `genus` and `species` are not always available. In cases when the `genus` and `species` variables are not available, taxonomic identifiers will be contained in the `sppcode` variable. This variable contains codes for species or other higher taxonomic unit. These codes are string of usually a few characters.


## Extra covariates

Most data sets provided by the USA LTER network contain more data than the standard variables accounted for by the standard schema of `popler`. In order not to loose the original data, popler stored all of the extra information in a character variable named `covariates`. The popler package provides two ways to format these covariates into a data frame: the `cov_unpack` argument in `get data`, and the `cov_unpack` function in popler.
Setting the `cov_unpack` argument to TRUE returns a data frame that combines the variables of a default query to popler, and the covariates contained in each particular study downloaded through popler.

```
get_data(proj_metadata_key == 47, cov_unpack = TRUE)
```

Using the `cov_unpack` function on a data frame downloaded using `get_data` returns a data frame of the covariates contained in the downloaded object.

```
d_47 <- get_data(proj_metadata_key == 47)
head( cov_unpack(d_47) )
```
